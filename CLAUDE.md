# CLAUDE.md

## 目的

このファイルは Claude Code の作業方針とプロジェクト固有ルールを定義します。

## 判断記録のルール

Claude Code は以下の形式で判断を記録します：

1. **判断内容の要約**: 何を決定したか
2. **検討した代替案**: どのような選択肢があったか
3. **採用しなかった案とその理由**: なぜその案を選ばなかったか
4. **前提条件・仮定・不確実性**: 判断の根拠となる条件や仮定
5. **他エージェントによるレビュー可否**: 判断が妥当かどうか他エージェントに確認すべきか

前提・仮定・不確実性を明示し、仮定を事実のように扱わない。

## プロジェクト概要

- **目的**: ブラウザ拡張機能の Stylus や Tampermonkey で利用できるユーザスタイルシート / ユーザスクリプトの置き場
- **主な機能**:
  - ユーザスタイルシート (.user.css) の管理と配信
  - ユーザスクリプト (.user.js) の管理と配信
  - メタデータの検証とバージョン管理
  - GitHub Pages によるファイル一覧の公開

## 重要ルール

- **会話言語**: 日本語
- **コード内コメント**: 日本語
- **エラーメッセージ**: 英語
- **コミット規約**: Conventional Commits に従う (`<description>` は日本語)
- **日本語と英数字の間**: 半角スペースを挿入

## 環境のルール

- **ブランチ命名**: Conventional Branch に従う (`<type>` は短縮形: feat, fix)
- **GitHub リポジトリ調査**: テンポラリディレクトリに git clone してコード検索
- **Renovate PR**: 既存の Renovate PR に対して追加コミットや更新を行わない

## 相談ルール

他エージェントに相談することができます。以下の観点で使い分けてください。

- **Codex CLI (ask-codex)**:
  - 実装コードに対するソースコードレビュー
  - 関数設計、モジュール内部の実装方針などの局所的な技術判断
  - アーキテクチャ、モジュール間契約、パフォーマンス／セキュリティといった全体影響の判断
  - 実装の正当性確認、機械的ミスの検出、既存コードとの整合性確認

- **Gemini CLI (ask-gemini)**:
  - SaaS 仕様、言語・ランタイムのバージョン差、料金・制限・クォータといった、最新の適切な情報が必要な外部依存の判断
  - 外部一次情報の確認、最新仕様の調査、外部前提条件の検証

他エージェントが指摘・異議を提示した場合、Claude Code は必ず以下のいずれかを行う。黙殺・無言での不採用は禁止する。

- 指摘を受け入れ、判断を修正する
- 指摘を退け、その理由を明示する

以下は必ず実施する:

- 他エージェントの提案を鵜呑みにせず、その根拠や理由を理解する
- 自身の分析結果と他エージェントの意見が異なる場合は、双方の視点を比較検討する
- 最終的な判断は、両者の意見を総合的に評価した上で、自身で下す

## 開発コマンド

```bash
# 依存関係のインストール
npm ci

# Lint (CSS と JS のメタデータ検証)
npm run lint

# CSS メタデータ検証
npm run lint-css

# JS メタデータ検証
npm run lint-js

# GitHub Pages 用のページ生成
npm run generate-pages
```

## アーキテクチャと主要ファイル

### アーキテクチャサマリー

- **css/**: ユーザスタイルシート (.user.css) を格納
- **js/**: ユーザスクリプト (.user.js) を格納
- **packages/**: メタデータ検証とページ生成のスクリプト
  - `css-meta.js`: CSS メタデータ検証
  - `js-meta.js`: JS メタデータ検証
  - `generate-pages.js`: GitHub Pages 用のページ生成
- **.github/workflows/**: GitHub Actions の設定

### 主要ディレクトリ

- `css/<ドメイン>/*.user.css`: 各ドメイン向けのユーザスタイルシート
- `js/<ドメイン>/*.user.js`: 各ドメイン向けのユーザスクリプト

## 実装パターン

### 推奨パターン

- ユーザスタイルシート / ユーザスクリプトは、対象ドメインごとにディレクトリを分ける
- メタデータは必須フィールドをすべて記載する
- ファイル変更時は必ずバージョンを更新する

### 非推奨パターン

- メタデータの固定値を変更する
- バージョンを更新せずにファイルを変更する

## テスト

### テスト方針

- メタデータ検証スクリプト (`packages/css-meta.js`, `packages/js-meta.js`) により検証を行う
- CI で自動的にメタデータ検証が実行される

### 追加テスト条件

- 新しいユーザスタイルシート / ユーザスクリプトを追加した場合:
  - メタデータが正しいことを確認する
  - 必須フィールドがすべて存在することを確認する
  - 固定値が正しいことを確認する

## ドキュメント更新ルール

### 更新対象

- `README.md` は GitHub Pages で自動生成されるため、手動更新は不要

### 更新タイミング

- 新しいユーザスタイルシート / ユーザスクリプトを追加した場合は、メタデータに正しい情報を記載する

## 作業チェックリスト

### 新規改修時

1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. PR がクローズされた不要ブランチが削除済みであることを確認する
5. 指定されたパッケージマネージャー (npm) で依存関係をインストールする

### コミット・プッシュ前

1. Conventional Commits に従っていることを確認する
2. センシティブな情報が含まれていないことを確認する
3. Lint / Format エラーがないことを確認する (`npm run lint`)
4. 動作確認を行う

### PR 作成前

1. PR 作成の依頼があることを確認する
2. センシティブな情報が含まれていないことを確認する
3. コンフリクトの恐れがないことを確認する

### PR 作成後

1. コンフリクトがないことを確認する
2. PR 本文が最新状態のみを網羅していることを確認する
3. `gh pr checks <PR ID> --watch` で CI を確認する
4. Copilot レビューに対応し、コメントに返信する
5. Codex のコードレビューを実施し、指摘対応を行う
6. PR 本文の崩れがないことを確認する

## リポジトリ固有

### メタデータ必須フィールド

- **CSS**: `name`, `namespace`, `version`, `homepageURL`, `supportURL`, `updateURL`, `description`, `author`, `license`
- **JS**: `name`, `namespace`, `version`, `description`, `author`, `homepageURL`, `supportURL`, `updateURL`, `downloadURL`, `match`, `grant`, `icon`, `license`

### メタデータ固定値

- `namespace`: `tomacheese.com`
- `author`: `Tomachi <tomachi@tomacheese.com> (https://github.com/book000)`
- `homepageURL`: `https://github.com/book000/browser-user-customs`
- `supportURL`: `https://github.com/book000/browser-user-customs/issues`
- `updateURL` (CSS): `https://raw.githubusercontent.com/book000/browser-user-customs/master/css/<ドメイン>/<ファイル名>`
- `updateURL` (JS): `https://raw.githubusercontent.com/book000/browser-user-customs/master/js/<ドメイン>/<ファイル名>`
- `downloadURL` (JS): `updateURL` と同じ

### バージョン管理

- ファイルを変更した場合は、必ずメタデータの `version` を更新する
- バージョンが更新されていない場合、CI で検証エラーとなる
- バージョンの形式: `major.minor.patch` (セマンティックバージョニングに従う)

### 特記事項

- メタデータの固定値は、CI で検証される。変更してはならない。
- 新しいユーザスタイルシート / ユーザスクリプトを追加する場合は、対象ドメインのディレクトリを作成する。
- GitHub Pages は自動的にファイル一覧を生成するため、手動でドキュメントを更新する必要はない。
